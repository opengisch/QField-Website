console.log("Main.js script loaded at:",(new Date).toISOString());let isInitialized=!1,initAttempts=0;function initializeApp(){if(initAttempts++,console.log(`Initialization attempt #${initAttempts}, readyState: ${document.readyState}`),isInitialized){console.log("App already initialized, skipping");return}const a=document.querySelector("[data-success-stories-filters]"),r=document.querySelectorAll(".success-story-card");if(a&&r.length===0&&(console.log("Filter container found but no cards yet, will retry..."),initAttempts<10)){setTimeout(initializeApp,100);return}if(console.log("Initializing app, readyState:",document.readyState,"at:",(new Date).toISOString()),isInitialized=!0,typeof bootstrap!="undefined"){const e=document.querySelectorAll('[data-bs-toggle="tooltip"]');e.forEach(e=>{new bootstrap.Tooltip(e)})}const e=document.querySelector(".navbar.sticky-top");if(e){let s=window.scrollY,t=!1;const o=()=>{const n=window.scrollY;n>10&&!t?(e.classList.add("scrolled"),t=!0):n<=10&&t&&(e.classList.remove("scrolled"),t=!1),s=n};let n=!1;const i=()=>{n||(requestAnimationFrame(()=>{o(),n=!1}),n=!0)};window.addEventListener("scroll",i,{passive:!0})}const t=document.getElementById("customers");t&&t.querySelectorAll(".customer-logos img").forEach(e=>{e.addEventListener("click",()=>{const n=t.querySelectorAll(`*[title="${e.title}"]`);n.forEach(e=>{Array.from(e.parentElement.children).forEach(e=>e.classList.remove("customer-active")),e.classList.add("customer-active")})})}),setTimeout(initializeGalleries,100);const i=document.getElementById("region-filters");if(i){const e=i.querySelectorAll("a[data-region]"),t=document.querySelectorAll(".panel[data-region]");console.log("Partner region filter initialized:",{filterLinks:e.length,panels:t.length});const n=n=>{console.log("Applying region filter:",n),e.forEach(e=>{e.dataset.region===n?e.classList.add("active"):e.classList.remove("active")});let s=0;t.forEach(e=>{const i=(e.dataset.region||"").split(/\s+/).filter(Boolean),t=n==="world"||i.includes(n),o=e.closest(".col-sm-6, .col-md-4");o&&(o.classList.toggle("d-none",!t),t&&s++)}),console.log("Region filter applied:",{region:n,visiblePanels:s})};n("world"),e.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.dataset.region;console.log("Region filter clicked:",s),n(s)})})}const n=document.querySelector("[data-success-stories-filters]");if(console.log("Looking for filter container:",n),window.testFilter=function(e){const t=document.querySelectorAll(".success-story-card");console.log("Manual test - found cards:",t.length),t.forEach((t,n)=>{const o=(t.dataset.categories||"").split(/\s+/).filter(Boolean),s=e==="all"||o.includes(e);t.classList.toggle("d-none",!s),console.log(`Card ${n}:`,{categories:t.dataset.categories,visible:s})})},n){const e=n.querySelectorAll("button[data-filter]"),t=document.querySelectorAll(".success-story-card");console.log("Filter system initialized:",{filterButtons:e.length,cards:t.length}),t.length>0&&console.log("First card data-categories:",t[0].dataset.categories);const s=n=>{const o=Array.from(e).map(e=>e.dataset.filter),s=o.includes(n)?n:"all";console.log("Applying filter:",{filter:n,normalizedFilter:s,supportedFilters:o}),e.forEach(e=>{const t=e.dataset.filter===s;e.classList.toggle("active",t),e.setAttribute("aria-pressed",t?"true":"false")});let i=0;t.forEach(e=>{const t=(e.dataset.categories||"").split(/\s+/).filter(Boolean),n=s==="all"||t.includes(s);e.classList.toggle("d-none",!n),n&&i++,!n&&s!=="all"&&console.log("Hiding card:",{categories:e.dataset.categories,parsed:t,filter:s,includes:t.includes(s)})}),console.log("Filter applied:",{filter:s,visibleCards:i})},o=new URLSearchParams(window.location.search),i=o.get("filter")||"all";s(i),e.forEach(e=>{e.addEventListener("click",t=>{console.log("Filter button clicked:",e.dataset.filter);const n=e.getAttribute("data-filter"),o=`${window.location.pathname}?filter=${encodeURIComponent(n)}`;window.history&&history.pushState&&history.pushState({filter:n},"",o),s(n)})}),window.addEventListener("popstate",e=>{const t=e.state?.filter||"all";s(t)})}const s=document.querySelector("[data-blog-view-grid]"),o=document.querySelectorAll("[data-blog-view-toggle]");if(s&&o.length>0){const e="qfieldBlogView",n=["cards","list"],i="list",a=e=>{o.forEach(t=>{const n=t.dataset.view===e;t.classList.toggle("active",n),t.setAttribute("aria-pressed",n?"true":"false")})},t=e=>{const t=n.includes(e)?e:i;s.classList.remove("blog-view--cards","blog-view--list"),s.classList.add(`blog-view--${t}`),a(t)},r=window.localStorage?localStorage.getItem(e):null;t(r),o.forEach(n=>{n.addEventListener("click",()=>{const s=n.dataset.view;t(s),window.localStorage&&localStorage.setItem(e,s)})})}}"addEventListener"in window&&window.addEventListener("beforeunload",()=>{isInitialized=!1,initAttempts=0});function tryInitialization(){console.log("Trying initialization, readyState:",document.readyState),document.readyState==="loading"?(console.log("Document still loading, adding DOMContentLoaded listener"),document.addEventListener("DOMContentLoaded",initializeApp,{once:!0})):(console.log("Document already loaded, initializing immediately"),initializeApp()),window.addEventListener("load",()=>{console.log("Window load event fired"),isInitialized||(console.log("Not yet initialized, trying now"),initializeApp())},{once:!0}),setTimeout(()=>{isInitialized||(console.log("Delayed backup initialization"),initializeApp())},250)}function initializeGalleries(){const e=document.querySelectorAll(".gallery-wrapper[data-gallery-id]");if(console.log("Initializing galleries:",e.length),e.forEach((e,t)=>{console.log(`Found gallery ${t+1}:`,e.dataset.galleryId)}),e.length===0){console.log("No gallery wrappers found, will retry in 100ms"),setTimeout(initializeGalleries,100);return}e.forEach(e=>{const t=e.dataset.galleryId,i=e.dataset.autoplay==="true",a=e.dataset.interval||"5000",r=e.dataset.controls!=="false",c=e.dataset.indicators!=="false";console.log(`Processing gallery ${t}`);const o=e.querySelectorAll("figure");if(console.log(`Gallery ${t} found ${o.length} figures`),o.length===0){console.log(`Gallery ${t} has no figures, hiding wrapper`),e.style.display="none";return}const s=document.createElement("div");s.id=t,s.className="carousel slide gallery-carousel mb-4",i&&s.setAttribute("data-bs-ride","carousel"),s.setAttribute("data-bs-interval",a);let n="";if(c&&o.length>1){n+='<div class="carousel-indicators">';for(let e=0;e<o.length;e++)n+=`<button type="button" data-bs-target="#${t}" data-bs-slide-to="${e}" 
                         ${e===0?'class="active" aria-current="true"':""} 
                         aria-label="Slide ${e+1}"></button>`;n+="</div>"}n+='<div class="carousel-inner">',o.forEach((e,t)=>{n+=`<div class="carousel-item${t===0?" active":""}">`,n+=e.outerHTML,n+="</div>"}),n+="</div>",r&&o.length>1&&(n+=`
        <button class="carousel-control-prev" type="button" data-bs-target="#${t}" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#${t}" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      `),s.innerHTML=n,e.parentNode.replaceChild(s,e);const l=s.querySelectorAll(".gallery-img");if(l.forEach((e,n)=>{e.style.cursor="pointer",e.addEventListener("click",e=>{e.preventDefault(),openGalleryFullscreen(t,n)})}),typeof bootstrap!="undefined"&&bootstrap.Carousel)try{new bootstrap.Carousel(s,{interval:parseInt(a),ride:!!i&&"carousel",pause:"hover",wrap:!0,keyboard:!0,touch:!0}),console.log(`Gallery ${t} Bootstrap carousel initialized`)}catch(e){console.error(`Failed to initialize Bootstrap carousel for ${t}:`,e)}else console.warn("Bootstrap not available for carousel initialization");console.log(`Gallery ${t} initialized successfully with ${o.length} slides`)})}function openGalleryFullscreen(e,t=0){const a=document.getElementById(e);if(!a)return;const n=Array.from(a.querySelectorAll(".gallery-img")).map(e=>({src:e.src,alt:e.alt||"",caption:e.closest("figure")?.querySelector("figcaption")?.textContent||""}));if(n.length===0)return;const s=document.createElement("div");s.className="gallery-lightbox",s.innerHTML=`
    <div class="gallery-lightbox__backdrop"></div>
    <div class="gallery-lightbox__container">
      <button class="gallery-lightbox__close" aria-label="Close gallery">Ã—</button>
      ${n.length>1?`
        <button class="gallery-lightbox__prev" aria-label="Previous image">
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="gallery-lightbox__next" aria-label="Next image">
          <span class="carousel-control-next-icon"></span>
        </button>
      `:""}
      <div class="gallery-lightbox__content">
        <img class="gallery-lightbox__image" src="${n[t].src}" alt="${n[t].alt}">
        ${n[t].caption?`<div class="gallery-lightbox__caption">${n[t].caption}</div>`:""}
      </div>
      ${n.length>1?`
        <div class="gallery-lightbox__counter">${t+1} / ${n.length}</div>
      `:""}
    </div>
  `,document.body.appendChild(s),document.body.style.overflow="hidden";let o=t;const r=e=>{o=e;const i=s.querySelector(".gallery-lightbox__image"),t=s.querySelector(".gallery-lightbox__caption"),a=s.querySelector(".gallery-lightbox__counter");i.src=n[e].src,i.alt=n[e].alt,t&&(n[e].caption?(t.textContent=n[e].caption,t.style.display="block"):t.style.display="none"),a&&(a.textContent=`${e+1} / ${n.length}`)},i=()=>{s.remove(),document.body.style.overflow=""},c=()=>{const e=o>0?o-1:n.length-1;r(e)},l=()=>{const e=o<n.length-1?o+1:0;r(e)};s.querySelector(".gallery-lightbox__close")?.addEventListener("click",i),s.querySelector(".gallery-lightbox__backdrop")?.addEventListener("click",i),s.querySelector(".gallery-lightbox__prev")?.addEventListener("click",c),s.querySelector(".gallery-lightbox__next")?.addEventListener("click",l);const d=e=>{e.key==="Escape"?i():e.key==="ArrowLeft"?c():e.key==="ArrowRight"&&l()};document.addEventListener("keydown",d),s.addEventListener("remove",()=>{document.removeEventListener("keydown",d)}),requestAnimationFrame(()=>{s.classList.add("gallery-lightbox--active")})}function initializeDonationPage(){const e=document.getElementById("donate-link");if(!e)return;document.querySelectorAll(".donation-btn").forEach(t=>{t.addEventListener("click",n=>{n.preventDefault();const s=document.querySelector(".tab-pane.active");s&&s.querySelectorAll(".donation-btn").forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),e.href=t.href})});const t=document.querySelector(".donation-btn.selected");t&&(e.href=t.href),document.querySelectorAll(".donation-tab").forEach(t=>{t.addEventListener("shown.bs.tab",function(){const s=this.getAttribute("data-bs-target"),n=document.querySelector(s);if(n){const t=n.querySelector(".donation-btn");t&&(n.querySelectorAll(".donation-btn").forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),e.href=t.href)}})})}function copyDonateLink(){const e="https://qfield.org/donate";navigator.clipboard.writeText(e).then(()=>{const e=event.target.closest("button"),t=e.innerHTML;e.innerHTML='<i class="fas fa-check"></i>',e.classList.remove("btn-outline-secondary"),e.classList.add("btn-success"),setTimeout(()=>{e.innerHTML=t,e.classList.remove("btn-success"),e.classList.add("btn-outline-secondary")},2e3)}).catch(e=>{console.error("Clipboard copy failed:",e),alert("Failed to copy the link. Please try again.")})}typeof window!="undefined"&&(window.copyDonateLink=copyDonateLink),tryInitialization(),initializeDonationPage()